# 入力検証仕様書

本ドキュメントは、収支報告書作成に必要な入力項目の検証ルールを定義します。

## 目次

1. [概要](#概要)
2. [法令上の記載要件](#法令上の記載要件)
3. [入力検証ルール](#入力検証ルール)
4. [実装方針](#実装方針)
5. [CSV 出力仕様](#csv-出力仕様)

---

## 概要

### 目的

収支報告書を作成する際、法令で求められる項目が正しく入力されているかを検証し、
不足がある場合はユーザーに警告を表示する。

### 対象報告書

| 報告書                 | 根拠法         | 対象台帳     |
| ---------------------- | -------------- | ------------ |
| 政治資金収支報告書     | 政治資金規正法 | organization |
| 選挙運動費用収支報告書 | 公職選挙法     | election     |

---

## 法令上の記載要件

### 政治資金収支報告書

#### 支出の記載要件

| 金額基準     | 記載内容                                             |
| ------------ | ---------------------------------------------------- |
| 1件5万円超   | 年月日、支出を受けた者の氏名・住所、金額、支出の目的 |
| 1件5万円以下 | 年月日、金額、支出の目的                             |

#### 寄附の記載要件

| 寄附者     | 金額基準    | 記載内容                                   |
| ---------- | ----------- | ------------------------------------------ |
| 個人       | 年間5万円超 | 氏名、住所、**職業**、金額                 |
| 法人・団体 | 年間5万円超 | 名称、主たる事務所の所在地、代表者名、金額 |
| 政治団体   | 1件すべて   | 名称、主たる事務所の所在地、代表者名、金額 |

### 選挙運動費用収支報告書

#### 支出の記載要件

| 項目         | 記載内容                                             |
| ------------ | ---------------------------------------------------- |
| 10費目すべて | 年月日、金額、支出の目的、支出を受けた者の氏名・住所 |
| 公費負担対象 | 上記＋公費負担額                                     |

#### 寄附の記載要件

| 寄附者   | 金額基準  | 記載内容                                   |
| -------- | --------- | ------------------------------------------ |
| 個人     | 1万円超   | 氏名、住所、職業、金額                     |
| 政治団体 | 1件すべて | 名称、主たる事務所の所在地、代表者名、金額 |

---

## 入力検証ルール

### ルール一覧

| ID   | 条件                         | 検証対象                       | エラーメッセージ                       | 重要度 |
| ---- | ---------------------------- | ------------------------------ | -------------------------------------- | ------ |
| V001 | 支出 & 金額 > 50,000         | contacts.address               | 5万円超の支出には住所が必要です        | 警告   |
| V002 | 収入 & 個人 & 金額 > 50,000  | contacts.address               | 5万円超の寄附には住所が必要です        | 警告   |
| V003 | 収入 & 個人 & 金額 > 50,000  | contacts.occupation            | 5万円超の個人寄附には職業が必要です    | 警告   |
| V004 | 選挙 & 公費対象科目          | amount_public_subsidy          | 公費負担額を入力してください           | 情報   |
| V005 | 収入 & 法人 & 金額 > 50,000  | contacts.address               | 5万円超の法人寄附には住所が必要です    | 警告   |
| V006 | 支出 & 証憑なし & 理由なし | receipt_hard_to_collect_reason | 証憑を添付できない理由を入力してください | エラー |

### 重要度の定義

| 重要度 | 表示 | 意味                                         |
| ------ | ---- | -------------------------------------------- |
| エラー | 🔴   | 保存不可。必ず修正が必要                     |
| 警告   | 🟠   | 保存可能だが、報告書作成時に問題になる可能性 |
| 情報   | 🔵   | 入力推奨。なくても問題ない場合が多い         |

---

## 実装方針

### Phase 1: フォーム改修

1. **公費負担額フィールド追加**（選挙台帳のみ）
   - `amount_public_subsidy` の入力欄を追加
   - 公費対象科目選択時のみ表示

2. **関係者登録フォーム改修**
   - 住所・職業フィールドを追加（既存）
   - 入力推奨のヒント表示

### Phase 2: リアルタイム検証

```
仕訳登録時の検証フロー:
1. 金額入力 → 5万円超なら警告表示
2. 関係者選択 → 住所/職業未入力なら警告表示
3. 送信時 → エラー項目があれば送信ブロック
```

### Phase 3: 一括検証（エクスポート前）

```
CSV エクスポート前の検証:
1. 対象期間の全仕訳を取得
2. 各仕訳に対して検証ルールを適用
3. 問題リストを表示
4. ユーザーが問題を確認後、エクスポート実行
```

---

## CSV 出力仕様

### 出力ファイル

| ファイル名                  | 内容           |
| --------------------------- | -------------- |
| `支出一覧_{YYYY}年度.csv`   | 支出仕訳の一覧 |
| `収入一覧_{YYYY}年度.csv`   | 収入仕訳の一覧 |
| `科目別集計_{YYYY}年度.csv` | 科目ごとの集計 |

### 支出一覧 CSV フォーマット

| 列名             | 内容                       | 備考                   |
| ---------------- | -------------------------- | ---------------------- |
| 年月日           | journal_date               | YYYY/MM/DD 形式        |
| 支出の目的       | description                | 摘要                   |
| 金額             | amount                     | 数値                   |
| 支払先氏名       | contacts.name              |                        |
| 支払先住所       | contacts.address           | 空欄の場合は警告       |
| 勘定科目         | account_code → name        | 報告書の分類に合わせる |
| 補助科目         | sub_account.name           |                        |
| 政党交付金充当額 | amount_political_grant     | 政治団体のみ           |
| 公費負担額       | amount_public_subsidy      | 選挙のみ               |
| 証憑なし       | is_receipt_hard_to_collect | ○ or 空欄              |
| 備考             | notes                      |                        |

### 収入一覧 CSV フォーマット

| 列名       | 内容                  | 備考             |
| ---------- | --------------------- | ---------------- |
| 年月日     | journal_date          | YYYY/MM/DD 形式  |
| 内容       | description           | 摘要             |
| 金額       | amount                | 数値             |
| 寄附者氏名 | contacts.name         |                  |
| 寄附者種別 | contacts.contact_type | 個人/法人        |
| 寄附者住所 | contacts.address      | 空欄の場合は警告 |
| 寄附者職業 | contacts.occupation   | 個人のみ         |
| 勘定科目   | account_code → name   |                  |
| 備考       | notes                 |                  |

### 科目別集計 CSV フォーマット

| 列名     | 内容                                      |
| -------- | ----------------------------------------- |
| 分類     | report_category（経常経費、政治活動費等） |
| 科目名   | account_name                              |
| 件数     | count                                     |
| 金額合計 | sum                                       |

---

## 更新履歴

| 日付       | バージョン | 内容     |
| ---------- | ---------- | -------- |
| 2024-12-17 | 1.0        | 初版作成 |
