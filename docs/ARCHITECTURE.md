# Polimoney Ledger - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

> âš ï¸ **é‡è¦**: Ledger ã¨ Hub ã¯ **åˆ¥ã€…ã® Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ** ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
>
> | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ                    | ç”¨é€”                                         |
> | ------------------------------- | -------------------------------------------- |
> | **ğŸ…°ï¸ Supabase A (Ledger å°‚ç”¨)** | æ”¿æ²»å®¶ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã€èªè¨¼ã€é ˜åæ›¸ä¿å­˜ |
> | **ğŸ…±ï¸ Supabase B (Hub å°‚ç”¨)**    | å…±é€šè­˜åˆ¥å­ã€å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã€ç®¡ç†è€…èªè¨¼           |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Fresh (Deno)                               â”‚
â”‚                   (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTPS
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Edge    â”‚         â”‚      Supabase Realtime        â”‚
â”‚  Functions (API)  â”‚         â”‚        (WebSocket)            â”‚
â”‚  - Hono + Deno    â”‚         â”‚  - ä»•è¨³å¤‰æ›´ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ…°ï¸ Supabase Project A (Ledger å°‚ç”¨)              â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
          â”‚  â”‚ [PostgreSQL]                â”‚                  â”‚
          â”‚  â”‚ - journals (ä»•è¨³)           â”‚                  â”‚
          â”‚  â”‚ - journal_entries (æ˜ç´°)    â”‚                  â”‚
          â”‚  â”‚ - contacts (é–¢ä¿‚è€…)         â”‚                  â”‚
          â”‚  â”‚ - sub_accounts (è£œåŠ©ç§‘ç›®)   â”‚                  â”‚
          â”‚  â”‚ - ledgers (å°å¸³)            â”‚                  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
          â”‚  â”‚ [Supabase Auth]             â”‚                  â”‚
          â”‚  â”‚ - OTP èªè¨¼ï¼ˆæ”¿æ²»å®¶å‘ã‘ï¼‰    â”‚                  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
          â”‚  â”‚ [Supabase Storage]          â”‚                  â”‚
          â”‚  â”‚ - é ˜åæ›¸ç”»åƒ                â”‚                  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ API é€£æº (X-API-Key)
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              Polimoney Hub (API)                  â”‚
          â”‚  - å…±é€šè­˜åˆ¥å­å–å¾— (GET /api/v1/elections ç­‰)      â”‚
          â”‚  - å…¬é–‹ãƒ‡ãƒ¼ã‚¿åŒæœŸ (POST /api/v1/sync)             â”‚
          â”‚                                                   â”‚
          â”‚  â†’ ğŸ…±ï¸ Supabase Project B (Hub å°‚ç”¨) ã«æ¥ç¶š       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              Polimoney (å¯è¦–åŒ–)                   â”‚
          â”‚  - Hub API ã‹ã‚‰å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 2.1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

| é …ç›®           | é¸æŠ                  | ç†ç”±                                       |
| -------------- | --------------------- | ------------------------------------------ |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | **Fresh (Deno)**      | Deno ãƒã‚¤ãƒ†ã‚£ãƒ–ã€Islands Architectureã€SSR |
| UI             | Preact + Tailwind CSS | è»½é‡ã€é«˜é€Ÿ                                 |
| ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°   | **Deno Deploy**       | Fresh ã¨æœ€é©åŒ–ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒƒã‚¸é…ä¿¡       |

### 2.2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API

| é …ç›®           | é¸æŠ                               | ç†ç”±                                 |
| -------------- | ---------------------------------- | ------------------------------------ |
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ      | **Deno (Supabase Edge Functions)** | TypeScript ãƒã‚¤ãƒ†ã‚£ãƒ–ã€Supabase çµ±åˆ |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | **Hono**                           | è»½é‡ã€Edge æœ€é©åŒ–ã€TypeScript        |
| ãƒ‡ãƒ—ãƒ­ã‚¤       | Supabase Edge Functions            | ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒƒã‚¸é…ä¿¡                 |

### 2.3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

| é …ç›®         | é¸æŠ                      | ç†ç”±                             |
| ------------ | ------------------------- | -------------------------------- |
| DB           | **PostgreSQL (Supabase)** | RLSã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€JSON å¯¾å¿œ |
| èªè¨¼         | Supabase Auth             | OTP æ–¹å¼ã€RLS ã¨ã®çµ±åˆ           |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸   | Supabase Storage          | é ˜åè¨¼ç”»åƒã®ä¿å­˜                 |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  | Supabase Realtime         | WebSocket ã«ã‚ˆã‚‹å¤‰æ›´é€šçŸ¥         |

### 2.4. ã‚¤ãƒ³ãƒ•ãƒ©

| é …ç›®            | é¸æŠ                       | ç†ç”±                       |
| --------------- | -------------------------- | -------------------------- |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰  | **Deno Deploy**            | Fresh ã¨æœ€é©åŒ–ã€ç„¡æ–™æ å……å®Ÿ |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/DB | **Supabase Cloud** (åˆæœŸ)  | é‹ç”¨è² è·æœ€å°åŒ–             |
| å°†æ¥çš„ç§»è¡Œå…ˆ    | Azure + Supabase Self-Host | ãƒ‡ãƒ¼ã‚¿ä¸»æ¨©ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–   |

---

## 3. é–‹ç™ºç’°å¢ƒ

### 3.1. æ¨å¥¨æ§‹æˆ

```
polimoney-ledger/
â”œâ”€â”€ .devcontainer/              # Dev Containerè¨­å®š
â”‚   â”œâ”€â”€ devcontainer.json
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ deno.json                   # Denoè¨­å®šï¼ˆfmt/lintå«ã‚€ï¼‰
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ web/                    # Fresh (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)
â”‚   â”‚   â”œâ”€â”€ routes/             # ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”‚   â”œâ”€â”€ islands/            # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ components/         # é™çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ fresh.gen.ts
â”‚   â”‚   â””â”€â”€ deno.json
â”‚   â”œâ”€â”€ api/                    # Supabase Edge Functions
â”‚   â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â”‚   â”œâ”€â”€ _shared/        # å…±é€šã‚³ãƒ¼ãƒ‰
â”‚   â”‚   â”‚   â”œâ”€â”€ journals/       # ä»•è¨³API
â”‚   â”‚   â”‚   â””â”€â”€ elections/      # é¸æŒ™ãƒã‚¹ã‚¿API
â”‚   â”‚   â””â”€â”€ import_map.json
â”‚   â””â”€â”€ shared/                 # å…±é€šå‹å®šç¾© (TypeScript)
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/             # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ seed.sql                # é–‹ç™ºç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ config.toml
â””â”€â”€ docs/
```

### 3.2. é–‹ç™ºãƒ„ãƒ¼ãƒ«

| ãƒ„ãƒ¼ãƒ«            | ç”¨é€”                               |
| ----------------- | ---------------------------------- |
| **Dev Container** | VS Code / Cursor ã§ã®çµ±ä¸€ç’°å¢ƒ      |
| **Supabase CLI**  | ãƒ­ãƒ¼ã‚«ãƒ« DB èµ·å‹•ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| **Deno**          | Fresh + Edge Functions é–‹ç™º        |
| **deno fmt**      | ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ï¼ˆçµ„ã¿è¾¼ã¿ï¼‰         |
| **deno lint**     | ãƒªãƒ³ã‚¿ãƒ¼ï¼ˆçµ„ã¿è¾¼ã¿ï¼‰               |

### 3.3. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºãƒ•ãƒ­ãƒ¼

```bash
# 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/digitaldemocracy2030/polimoney_ledger.git
cd polimoney_ledger

# 2. Supabase ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•
supabase start

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
supabase db push

# 4. ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
supabase db seed

# 5. Edge Functionsèµ·å‹•
supabase functions serve

# 6. Fresh (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰) èµ·å‹•
cd packages/web && deno task start
```

### 3.4. VS Code / Cursor è¨­å®š

```json
// .vscode/settings.json
{
  "deno.enable": true,
  "deno.enablePaths": ["./packages/web", "./packages/api/functions"],
  "editor.formatOnSave": true,
  "[typescript]": {
    "editor.defaultFormatter": "denoland.vscode-deno"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "denoland.vscode-deno"
  }
}
```

---

## 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 4.1. èªè¨¼ãƒ»èªå¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èªè¨¼ãƒ•ãƒ­ãƒ¼ (OTP)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›                          â”‚
â”‚ 2. Supabase Auth ãŒ OTP ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡                        â”‚
â”‚ 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ OTP ã‚’å…¥åŠ›                                    â”‚
â”‚ 4. JWT ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ                                         â”‚
â”‚ 5. ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« JWT ã‚’ä»˜ä¸                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2. Row Level Security (RLS)

```sql
-- ä¾‹: journals ãƒ†ãƒ¼ãƒ–ãƒ«ã® RLS
CREATE POLICY "Users can only access their own journals"
ON journals FOR ALL
USING (
  auth.uid() IN (
    SELECT user_id FROM ledger_members
    WHERE organization_id = journals.organization_id
       OR election_id = journals.election_id
  )
);
```

### 4.3. ãƒ‡ãƒ¼ã‚¿ä¿è­·

| å±¤       | å¯¾ç­–                        |
| -------- | --------------------------- |
| é€šä¿¡     | HTTPS (TLS 1.3)             |
| ä¿å­˜     | PostgreSQL æš—å·åŒ– (At-rest) |
| ã‚¢ã‚¯ã‚»ã‚¹ | RLS + JWT æ¤œè¨¼              |
| ç›£æŸ»     | å¤‰æ›´ãƒ­ã‚°ã®è‡ªå‹•è¨˜éŒ²          |

---

## 5. API è¨­è¨ˆ

### 5.1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹                        | èª¬æ˜                       |
| -------- | --------------------------- | -------------------------- |
| GET      | `/api/journals`             | ä»•è¨³ä¸€è¦§å–å¾—               |
| POST     | `/api/journals`             | ä»•è¨³ç™»éŒ²                   |
| PUT      | `/api/journals/:id`         | ä»•è¨³æ›´æ–°                   |
| DELETE   | `/api/journals/:id`         | ä»•è¨³å‰Šé™¤                   |
| POST     | `/api/journals/:id/approve` | ä»•è¨³æ‰¿èª                   |
| GET      | `/api/elections`            | é¸æŒ™ãƒã‚¹ã‚¿å–å¾—             |
| GET      | `/api/organizations`        | æ”¿æ²»å›£ä½“ãƒã‚¹ã‚¿å–å¾—         |
| POST     | `/api/export/polimoney`     | Polimoney å‘ã‘ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ |

### 5.2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥

```typescript
// Supabase Realtime ã§ãƒªãƒƒã‚¹ãƒ³
const channel = supabase
  .channel("journals")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "journals",
      filter: `organization_id=eq.${orgId}`,
    },
    (payload) => {
      // UIã‚’æ›´æ–°
    }
  )
  .subscribe();
```

---

## 6. Polimoney é€£æº

### 6.1. å…±é€šè­˜åˆ¥å­ã®ç®¡ç†æ–¹é‡ï¼ˆé‡è¦ï¼‰

> âš ï¸ **Hub ã¯å…±é€šè­˜åˆ¥å­ã®å”¯ä¸€ã®æƒ…å ±æº (Single Source of Truth) ã§ã™ã€‚**
>
> Ledger ã¯å…±é€šè­˜åˆ¥å­ï¼ˆpoliticians, organizations, electionsï¼‰ã‚’
> **ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã›ã‚“**ã€‚Hub API ã‹ã‚‰å–å¾—ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§æ€§èƒ½ã‚’æ‹…ä¿ã—ã¾ã™ã€‚

**è©³ç´°:** `docs/IDENTITY_DESIGN.md` ã‚’å‚ç…§

| è­˜åˆ¥å­      | å½¢å¼ | ä¿å­˜å…ˆ                 | Ledger ã§ã®æ‰±ã„     |
| ----------- | ---- | ---------------------- | ------------------- |
| é¸æŒ™ ID     | UUID | ğŸ…±ï¸ Hub (Supabase B)    | ID ã®ã¿å‚ç…§         |
| æ”¿æ²»å›£ä½“ ID | UUID | ğŸ…±ï¸ Hub (Supabase B)    | ID ã®ã¿å‚ç…§         |
| æ”¿æ²»å®¶ ID   | UUID | ğŸ…±ï¸ Hub (Supabase B)    | ID ã®ã¿å‚ç…§         |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID | UUID | ğŸ…°ï¸ Ledger (Supabase A) | `auth.uid()` ã§ç®¡ç† |

### 6.2. é€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ…±ï¸ Hub (Supabase B)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å…±é€šè­˜åˆ¥å­ï¼ˆSingle Source of Truthï¼‰                          â”‚ â”‚
â”‚  â”‚ - politicians, organizations, elections                       â”‚ â”‚
â”‚  â”‚ - public_ledgers, public_journals (å…¬é–‹ãƒ‡ãƒ¼ã‚¿)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    Hub API (èªè¨¼: X-API-Key)
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚                         â”‚
        â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ledger        â”‚         â”‚ Polimoney     â”‚         â”‚ å°†æ¥ã®æ¶ˆè²»è€…  â”‚
â”‚ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥)  â”‚         â”‚ (å¯è¦–åŒ–)      â”‚         â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ…°ï¸ Ledger (Supabase A)                         â”‚
â”‚  - journals ã« election_id, organization_id ã‚’ UUID ã§å‚ç…§       â”‚
â”‚  - elections/organizations/politicians ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã—ãªã„      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3. Hub ã®å½¹å‰²

| æ©Ÿèƒ½           | èª¬æ˜                                             |
| -------------- | ------------------------------------------------ |
| å…±é€šè­˜åˆ¥å­ç®¡ç† | politicians, organizations, elections ã‚’ä¸€å…ƒç®¡ç† |
| å…¬é–‹ãƒ‡ãƒ¼ã‚¿ä¿å­˜ | Ledger ã‹ã‚‰åŒæœŸã•ã‚ŒãŸå…¬é–‹ç”¨ä»•è¨³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜      |
| åŒ¿ååŒ–         | `is_name_private` ç­‰ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›         |
| API æä¾›       | Ledger / Polimoney / å°†æ¥ã®æ¶ˆè²»è€…ã¸ API æä¾›     |

### 6.4. èªè¨¼æ–¹å¼

| é€šä¿¡              | èªè¨¼æ–¹å¼                       |
| ----------------- | ------------------------------ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Ledger | JWT (ğŸ…°ï¸ Supabase A Auth)       |
| Ledger â†’ Hub      | API Key (`X-API-Key` ãƒ˜ãƒƒãƒ€ãƒ¼) |
| ç®¡ç†è€… â†’ Hub      | JWT (ğŸ…±ï¸ Supabase B Auth)       |
| Polimoney â†’ Hub   | API Key (`X-API-Key` ãƒ˜ãƒƒãƒ€ãƒ¼) |

### 6.5. Hub ãŒãƒ€ã‚¦ãƒ³ã—ãŸå ´åˆ

**Hub ãŒãƒ€ã‚¦ãƒ³ = Polimoney 3 ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆå…¨ä½“ãŒãƒ€ã‚¦ãƒ³**

ã“ã‚Œã¯è¨±å®¹ã•ã‚Œã‚‹è¨­è¨ˆåˆ¤æ–­ã§ã™ã€‚ç†ç”±ï¼š

- Hub ã¯ Deno Deploy + Supabase ã§é«˜å¯ç”¨æ€§
- å…±é€šè­˜åˆ¥å­ã®äºŒé‡ç®¡ç†ã«ã‚ˆã‚‹ä¸æ•´åˆãƒªã‚¹ã‚¯ã‚’é¿ã‘ã‚‹
- åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã®è¤‡é›‘ã•ã‚’é¿ã‘ã‚‹

---

## 7. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æˆ¦ç•¥

### 7.1. å¹´åº¦ç· ã‚æ©Ÿèƒ½ï¼ˆæ”¿æ²»å›£ä½“å°å¸³ï¼‰

æ”¿æ²»å›£ä½“å°å¸³ã¯ 1 å°å¸³ã§è¤‡æ•°å¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ï¼ˆå¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿æ–¹å¼ï¼‰ã€‚
å„å¹´åº¦ã¯å€‹åˆ¥ã«ã€Œç· ã‚å‡¦ç†ã€ãŒå¯èƒ½ã€‚

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»:**

```
openï¼ˆç·¨é›†å¯èƒ½ï¼‰
    â”‚
    â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå¹´åº¦ç· ã‚ã€ï¼ˆæ‰‹å‹•ï¼‰
    â”‚ ã¾ãŸã¯ å¹´åº¦çµ‚äº†ã‹ã‚‰ 3å¹´çµŒéï¼ˆè‡ªå‹•ï¼‰
    â–¼
closedï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    â”‚
    â”‚ ç· ã‚ã‹ã‚‰ 1å¹´çµŒéï¼ˆè‡ªå‹•ï¼‰
    â–¼
lockedï¼ˆå®Œå…¨ãƒ­ãƒƒã‚¯ï¼‰
    â”‚ - é ˜åæ›¸ç”»åƒ: Ledger DB â†’ Hub DB ã«ç§»è¡Œ
    â”‚ - Ledger Storage ã‹ã‚‰å‰Šé™¤
    â”‚
    â”‚ ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ
    â–¼
temporary_unlockï¼ˆä¸€æ™‚è§£é™¤ã€7æ—¥é–“ï¼‰
    â”‚
    â”‚ ä¿®æ­£å®Œäº† or æœŸé™åˆ‡ã‚Œ
    â–¼
lockedï¼ˆå†ãƒ­ãƒƒã‚¯ï¼‰
```

**å¹´åº¦ç· ã‚ã®ãƒˆãƒªã‚¬ãƒ¼:**

| æ–¹å¼ | ã‚¿ã‚¤ãƒŸãƒ³ã‚°              | èª¬æ˜                 |
| ---- | ----------------------- | -------------------- |
| æ‰‹å‹• | éšæ™‚                    | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä¿ƒã™ |
| è‡ªå‹• | å¹´åº¦çµ‚äº†ã‹ã‚‰ **3 å¹´å¾Œ** | æ³•å®šä¿å­˜æœŸé–“ã«åŸºã¥ã |

### 7.2. ãƒ‡ãƒ¼ã‚¿ä¿å­˜å ´æ‰€

| æœŸé–“   | ä»•è¨³ãƒ‡ãƒ¼ã‚¿                          | é ˜åæ›¸ç”»åƒ           | ç·¨é›†    |
| ------ | ----------------------------------- | -------------------- | ------- |
| open   | Ledger DB                           | Ledger Storage       | âœ… å¯   |
| closed | Ledger DB                           | Ledger Storage       | âŒ ä¸å¯ |
| locked | Ledger DBï¼ˆéå…¬é–‹ï¼‰+ Hub DBï¼ˆå…¬é–‹ï¼‰ | **Hub Storage ã®ã¿** | âŒ ä¸å¯ |

**éå…¬é–‹ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„:**

- éå…¬é–‹æƒ…å ±ï¼ˆ`is_name_private` ç­‰ï¼‰ã¯ **Ledger DB ã«æ®‹ã™**
- Hub DB ã«ã¯åŒ¿ååŒ–æ¸ˆã¿ã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜
- Hub Admin ã¯éå…¬é–‹ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯

### 7.3. ãƒ­ãƒƒã‚¯è§£é™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ:

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Ledger ã‹ã‚‰ã€Œä¿®æ­£ä¾é ¼ã€ã‚’é€ä¿¡
   - å¯¾è±¡: å°å¸³ + å¹´åº¦ï¼ˆã¾ãŸã¯é¸æŒ™å°å¸³ï¼‰
   - ç†ç”±: ä¿®æ­£ãŒå¿…è¦ãªç†ç”±ã‚’è¨˜è¼‰

2. Hub Admin ãŒç¢ºèªãƒ»æ‰¿èª
   - å½¢å¼çš„ãªãƒã‚§ãƒƒã‚¯ã®ã¿
   - ã€Œæ‰¿èªã€ã‚¯ãƒªãƒƒã‚¯ã§ä¸€æ™‚è§£é™¤

3. ä¸€æ™‚è§£é™¤ï¼ˆ7æ—¥é–“ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿®æ­£ã‚’å®Ÿæ–½
   - ä¿®æ­£å®Œäº†å¾Œã€Œå†ç· ã‚ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã¾ãŸã¯ 7æ—¥çµŒéã§è‡ªå‹•å†ãƒ­ãƒƒã‚¯
```

**ç®¡ç†è€…ã®ä½œæ¥­ã¯æœ€å°é™:**

| ä½œæ¥­             | æ‹…å½“         | å·¥æ•° |
| ---------------- | ------------ | ---- |
| ä¿®æ­£ç†ç”±ã®ç¢ºèª   | Admin        | 1 åˆ† |
| ã€Œæ‰¿èªã€ã‚¯ãƒªãƒƒã‚¯ | Admin        | 5 ç§’ |
| å®Ÿéš›ã®ä¿®æ­£ä½œæ¥­   | **ãƒ¦ãƒ¼ã‚¶ãƒ¼** | -    |
| å†ãƒ­ãƒƒã‚¯         | **è‡ªå‹•**     | -    |

### 7.4. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```sql
-- å¹´åº¦ç· ã‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
CREATE TABLE ledger_year_closures (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ledger_id UUID NOT NULL REFERENCES ledgers(id),
    fiscal_year INTEGER NOT NULL,
    status TEXT NOT NULL DEFAULT 'open',
    -- open / closed / locked / temporary_unlock
    closed_at TIMESTAMPTZ,
    locked_at TIMESTAMPTZ,
    storage_migrated_at TIMESTAMPTZ,
    UNIQUE(ledger_id, fiscal_year)
);

-- ãƒ­ãƒƒã‚¯è§£é™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
CREATE TABLE unlock_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ledger_id UUID REFERENCES ledgers(id),
    election_id UUID REFERENCES elections(id),
    fiscal_year INTEGER,
    reason TEXT NOT NULL,
    requested_by_user_id UUID NOT NULL,
    requested_at TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'pending',
    -- pending / approved / rejected / completed / expired
    reviewed_by_admin_id UUID,
    reviewed_at TIMESTAMPTZ,
    unlocked_at TIMESTAMPTZ,
    unlock_expires_at TIMESTAMPTZ,
    relocked_at TIMESTAMPTZ,
    CHECK (ledger_id IS NOT NULL OR election_id IS NOT NULL)
);
```

---

## 8. æ­£ç¢ºæ€§ãƒ»æ•´åˆæ€§ã®æ‹…ä¿

### 7.1. è¤‡å¼ç°¿è¨˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// å€Ÿæ–¹åˆè¨ˆ = è²¸æ–¹åˆè¨ˆ ã®ãƒã‚§ãƒƒã‚¯
function validateJournal(entries: JournalEntry[]): boolean {
  const debitSum = entries.reduce((sum, e) => sum + e.debit_amount, 0);
  const creditSum = entries.reduce((sum, e) => sum + e.credit_amount, 0);
  return debitSum === creditSum;
}
```

### 7.2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

```sql
BEGIN;
  INSERT INTO journals (...) VALUES (...) RETURNING id;
  INSERT INTO journal_entries (...) VALUES (...);
  INSERT INTO journal_entries (...) VALUES (...);
COMMIT;
```

### 7.3. æ¥½è¦³çš„ãƒ­ãƒƒã‚¯

```sql
UPDATE journals
SET description = '...', updated_at = now()
WHERE id = $1 AND updated_at = $2;  -- ç«¶åˆæ¤œçŸ¥
```

---

## 9. ä»Šå¾Œã®æ¤œè¨äº‹é …

- [ ] Azure ã¸ã®ç§»è¡Œï¼ˆSupabase Self-Hostï¼‰
- [ ] CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆGitHub Actionsï¼‰
- [ ] E2E ãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆSentryï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

---

## æ›´æ–°å±¥æ­´

- åˆç‰ˆä½œæˆ
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æˆ¦ç•¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
- å¹´åº¦ç· ã‚ãƒ»ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã‚’è¿½åŠ 
