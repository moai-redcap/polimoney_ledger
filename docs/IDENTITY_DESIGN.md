# 識別子設計書 - Polimoney 連携

> **更新**: 2025-12-14
>
> ⚠️ **注意**: 当初「Azure DB」として設計されていた共通識別子管理は、
> **Hub (Supabase B)** で実装されました。このドキュメントは現行アーキテクチャを反映しています。

## 1. 背景と課題

### 1.1. 現状の問題

| 問題              | 詳細                                                         |
| ----------------- | ------------------------------------------------------------ |
| 識別子の分散      | 政治家・政治団体・選挙の識別子が Polimoney と別々に管理      |
| contact_id の誤用 | 「自分自身」を contact（関係者）として登録する設計は不自然   |
| SaaS 化の課題     | DD2030 ホスティングに伴い、Auth/アカウント設計の見直しが必要 |

### 1.2. 解決策

1. **Polimoney との識別子共通化**: 政治家・政治団体・選挙の識別子を **Hub (Supabase B)** で一元管理
2. **contact_id の正しい使い方**: 外部関係者（寄附者・支出先）のみに限定
3. **SaaS 化対応**: DD2030 ホスティング前提の Auth/アカウント設計

---

## 2. 識別子アーキテクチャ

### 2.1. データの配置

```
┌─────────────────────────────────────────────────────────────┐
│              🅱️ Hub (Supabase B) - 共通識別子               │
│              ← Polimoney / Polimoney Ledger 共有            │
├─────────────────────────────────────────────────────────────┤
│ politicians        │ 政治家マスタ                           │
│ organizations      │ 政治団体マスタ                         │
│ elections          │ 選挙マスタ                             │
│ districts          │ 選挙区マスタ                           │
│ municipalities     │ 市区町村マスタ                         │
│ public_ledgers     │ 公開台帳データ                         │
│ public_journals    │ 公開仕訳データ                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 参照 (politician_id, org_id, election_id)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              🅰️ Ledger (Supabase A) - ユーザーデータ        │
│              ← Polimoney Ledger 専用                        │
├─────────────────────────────────────────────────────────────┤
│ auth.users         │ ユーザー認証                           │
│ profiles           │ ユーザープロファイル                   │
│ journals           │ 仕訳データ（プライベート）             │
│ journal_entries    │ 仕訳明細                               │
│ contacts           │ 外部関係者（寄附者・支出先のみ）       │
│ sub_accounts       │ 補助科目                               │
│ media_assets       │ 領収証等                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2. 識別子の形式

| 識別子      | 形式    | 保存先         | 例                       |
| ----------- | ------- | -------------- | ------------------------ |
| 政治家 ID   | UUID v4 | 🅱️ Hub         | `987fcdeb-51a2-4abc-...` |
| 政治団体 ID | UUID v4 | 🅱️ Hub         | `123e4567-e89b-4abc-...` |
| 選挙 ID     | UUID v4 | 🅱️ Hub         | `456e7890-e89b-4abc-...` |
| ユーザー ID | UUID v4 | 🅰️ Ledger Auth | `auth.uid()`             |
| 仕訳 ID     | UUID v4 | 🅰️ Ledger      | `journals.id`            |

### 2.3. 選挙区の分類

| コード | 種別           | 例                 |
| ------ | -------------- | ------------------ |
| HR     | 衆議院小選挙区 | 東京都第 1 区      |
| HC     | 参議院選挙区   | 東京都選挙区       |
| PG     | 都道府県知事   | 東京都知事選挙     |
| PA     | 都道府県議会   | 東京都議会議員選挙 |
| GM     | 市区町村長     | 新宿区長選挙       |
| CM     | 市区町村議会   | 新宿区議会議員選挙 |

---

## 3. 認証設計

### 3.1. Ledger ユーザー認証

| 項目               | 方式             | 備考         |
| ------------------ | ---------------- | ------------ |
| 新規登録           | Email + Password | OTP で確認   |
| ログイン           | Email + Password | 標準的な方式 |
| パスワードリセット | Magic Link       | メール送信   |

### 3.2. Hub 管理者認証

| 項目       | 方式             | 備考             |
| ---------- | ---------------- | ---------------- |
| 登録招待   | Magic Link (OTP) | 管理者が招待     |
| ログイン   | Email + Password | 標準的な方式     |
| メール変更 | OTP 確認         | セキュリティ強化 |

### 3.3. サービス間認証

| 通信            | 認証方式                       |
| --------------- | ------------------------------ |
| Ledger → Hub    | API Key (`X-API-Key` ヘッダー) |
| Polimoney → Hub | API Key (`X-API-Key` ヘッダー) |

---

## 4. contacts テーブルの役割

### 4.1. 用途

```
contacts:
- 寄附者（個人・法人）
- 支出先
- 銀行・借入先

※ 政治家本人は Hub の politicians テーブルで管理
※ 「自己資金」の仕訳は contact_id = NULL（振替扱い）
```

### 4.2. プライバシー設定

| フィールド            | 用途                           |
| --------------------- | ------------------------------ |
| is_name_private       | 氏名を非公開にする             |
| is_address_private    | 住所を非公開にする             |
| is_occupation_private | 職業を非公開にする             |
| privacy_reason_type   | 非公開理由（personal_info 等） |

---

## 5. Hub API エンドポイント

### 5.1. 共通識別子取得（読み取り専用）

| メソッド | パス                    | 説明             |
| -------- | ----------------------- | ---------------- |
| GET      | `/api/v1/elections`     | 選挙一覧取得     |
| GET      | `/api/v1/organizations` | 政治団体一覧取得 |
| GET      | `/api/v1/politicians`   | 政治家一覧取得   |
| GET      | `/api/v1/districts`     | 選挙区一覧取得   |

### 5.2. データ同期（Ledger → Hub）

| メソッド | パス           | 説明                 |
| -------- | -------------- | -------------------- |
| POST     | `/api/v1/sync` | 公開仕訳データの同期 |

### 5.3. 登録リクエスト

| メソッド | パス                            | 説明                    |
| -------- | ------------------------------- | ----------------------- |
| POST     | `/api/v1/election-requests`     | 選挙登録リクエスト      |
| POST     | `/api/v1/organization-requests` | 政治団体登録リクエスト  |
| POST     | `/api/v1/registration-requests` | Ledger ユーザー登録申請 |

---

## 6. 実装ステータス

| フェーズ           | 状態      | 備考                 |
| ------------------ | --------- | -------------------- |
| Hub API 構築       | ✅ 完了   | Deno + Hono          |
| 共通識別子テーブル | ✅ 完了   | Supabase B           |
| Ledger → Hub 同期  | ⏳ 進行中 | sync-transform.ts    |
| 登録リクエスト承認 | ✅ 完了   | Hub Admin UI         |
| 年度締め・ロック   | 🔲 未着手 | TODO_UNIFIED.md 参照 |

---

## 更新履歴

- 2025-12-14: Azure DB → Hub (Supabase B) に全面更新
- 初版作成
