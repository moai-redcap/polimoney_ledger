# Polimoney Ledger TODO

最終更新: 2025-12-17

> ⚠️ **方針**: Ledger を先に完成させてから Hub を進める。
> Ledger 開発中に DB 構成変更やマスタ追加が発生する可能性があるため。

---

## 📊 タスク一覧

### 🟢 完了済み

| #   | タスク                                  | 完了日     |
| --- | --------------------------------------- | ---------- |
| ✓   | Fresh (Deno) への移行                   | 2024-12    |
| ✓   | Supabase 認証（OTP）実装                | 2024-12    |
| ✓   | 仕訳登録 API 実装                       | 2024-12    |
| ✓   | 仕訳一覧画面                            | 2024-12    |
| ✓   | 複式簿記対応（借方/貸方）               | 2024-12    |
| ✓   | 関係者マスタ管理                        | 2024-12    |
| ✓   | 補助科目マスタ管理                      | 2024-12    |
| ✓   | 政治団体新規作成                        | 2024-12    |
| ✓   | 選挙登録リクエストページ                | 2024-12    |
| ✓   | `ledger_year_closures` テーブル作成     | 2024-12    |
| ✓   | `sub_accounts` RLS 追加                 | 2024-12    |
| ✓   | データエクスポート (JSON)               | 2024-12    |
| ✓   | プライバシーポリシー                    | 2024-12    |
| ✓   | ポリシー変更通知機能（バナー）          | 2024-12    |
| ✓   | お問い合わせフォーム（Google Form）     | 2024-12    |
| ✓   | Hub 同期 API 実装（承認時自動同期）     | 2024-12    |
| ✓   | 領収証添付機能                          | 2024-12    |
| ✓   | 仕訳承認画面                            | 2024-12    |
| ✓   | 仕訳登録ドロワー UI                     | 2025-12-17 |
| ✓   | ロゴ・ファビコン設定                    | 2025-12-17 |
| ✓   | ドキュメント整備（ACCOUNT_CODES.md 等） | 2025-12-17 |

---

### 🔥 優先度高（MVP 完成）

| #   | タスク                     | 状態      | 詳細                                       |
| --- | -------------------------- | --------- | ------------------------------------------ |
| 1   | Hub 同期機能（送信側）完成 | 🔲 未着手 | 承認時の自動同期 + 手動再同期              |
| 2   | 収支報告書出力             | 🔲 未着手 | PDF/Excel 出力（選挙種別で様式異なる）     |
| 3   | 画像エクスポート（ZIP）    | 🔲 未着手 | 領収書画像も含めた完全なデータエクスポート |

---

### 📋 中優先度（Phase 2-3）

| #   | タスク                 | 状態      | 詳細                         |
| --- | ---------------------- | --------- | ---------------------------- |
| 1   | 年度締め機能           | 🔲 未着手 | UI + closed ステータス遷移   |
| 2   | ロック/アーカイブ機能  | 🔲 未着手 | locked ステータス + 画像移行 |
| 3   | ロック解除リクエスト   | 🔲 未着手 | Hub Admin への依頼 UI        |
| 4   | 台帳設定・メンバー管理 | 🔲 未着手 | LedgerSettingsScreen         |
| 5   | 複合仕訳対応           | 🔲 未着手 | 複数行の支払元               |
| 6   | 関係者匿名化ロジック   | 🔲 未着手 | Hub 同期時の匿名化処理       |

---

### 📝 低優先度（Phase 4+）

| #   | タスク               | 状態      | 詳細               |
| --- | -------------------- | --------- | ------------------ |
| 1   | マネーフォワード連携 | 🔲 未着手 | OAuth2 + 明細取得  |
| 2   | CSV インポート       | 🔲 未着手 | transaction_drafts |
| 3   | Freee 連携           | 🔲 未着手 | OAuth2 + 明細取得  |
| 4   | AI 科目推奨          | 🔲 未着手 | 摘要からの推論     |
| 5   | パスワードリセット   | 🔲 未着手 | OTP 方式           |

---

## 🔗 Hub 連携タスク

Ledger と Hub の両方で作業が必要なもの。

| タスク             | Hub 側             | Ledger 側            |
| ------------------ | ------------------ | -------------------- |
| 同期 API           | ✅ 受信実装済      | 🔲 送信ロジック      |
| ロック解除フロー   | ✅ 承認 API 実装済 | 🔲 リクエスト送信 UI |
| 匿名化ルール       | -                  | 🔲 contacts 匿名化   |
| 画像ストレージ移行 | 受信               | 🔲 送信              |

---

## 📊 API エンドポイント一覧

### 仕訳 API

| Method | Endpoint                    | 説明         |
| ------ | --------------------------- | ------------ |
| GET    | `/api/journals`             | 仕訳一覧取得 |
| POST   | `/api/journals`             | 仕訳登録     |
| PUT    | `/api/journals/:id`         | 仕訳更新     |
| DELETE | `/api/journals/:id`         | 仕訳削除     |
| POST   | `/api/journals/:id/approve` | 仕訳承認     |

### マスタ API

| Method | Endpoint            | 説明         |
| ------ | ------------------- | ------------ |
| GET    | `/api/contacts`     | 関係者一覧   |
| POST   | `/api/contacts`     | 関係者登録   |
| PUT    | `/api/contacts/:id` | 関係者更新   |
| DELETE | `/api/contacts/:id` | 関係者削除   |
| GET    | `/api/sub-accounts` | 補助科目一覧 |
| POST   | `/api/sub-accounts` | 補助科目登録 |

### エクスポート API

| Method | Endpoint                         | 説明                     |
| ------ | -------------------------------- | ------------------------ |
| GET    | `/api/export`                    | JSON エクスポート        |
| GET    | `/api/export?include_media=true` | ZIP エクスポート（予定） |

### Hub 連携 API

| Method | Endpoint                     | 説明                   |
| ------ | ---------------------------- | ---------------------- |
| POST   | `/api/election-requests`     | 選挙登録リクエスト送信 |
| POST   | `/api/organization-requests` | 団体登録リクエスト送信 |

---

## 📋 技術的な課題

### 1. 匿名化ロジック

Hub に同期する際、`contacts` の情報を匿名化する必要がある。

| contacts カラム | 条件                            | Hub へ送信する値 |
| --------------- | ------------------------------- | ---------------- |
| `name`          | `is_name_private == true`       | `"非公開"`       |
| `name`          | `is_name_private == false`      | そのまま         |
| `address`       | `is_address_private == true`    | 送信しない       |
| `occupation`    | `is_occupation_private == true` | 送信しない       |
| `contact_type`  | 常に                            | そのまま公開     |

### 2. 収支報告書フォーマット

選挙種別によって様式が異なる。

| 選挙タイプ | 様式                   |
| ---------- | ---------------------- |
| 政治団体   | 政治資金収支報告書     |
| 選挙運動   | 選挙運動費用収支報告書 |

---

## 更新履歴

- 2025-12-17: TODO.md を新規作成（TODO_UNIFIED.md から統合）
- 2024-12-14: TODO_UNIFIED.md 初版作成
